<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Excel Merger ‚Äì Enhanced UI</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0b1025;
  --card:rgba(255,255,255,0.08);
  --border:rgba(255,255,255,0.18);
  --accent:#7c3aed;
}

*{box-sizing:border-box}

body{
  background:radial-gradient(circle at top,#141b3a,#0b1025);
  color:#fff;
  font-family:Inter,system-ui;
  padding:20px;
}

h2{font-size:26px;margin-bottom:4px}
h3{margin-bottom:10px;color:#e5e7eb}
.small{opacity:.75;font-size:13px}

.card{
  background:var(--card);
  padding:18px;
  border-radius:16px;
  margin-bottom:18px;
  border:1px solid var(--border);
  backdrop-filter:blur(10px);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.btn{
  padding:10px 18px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(90deg,#6ee7b7,#7c3aed);
  color:#000;
  transition:.25s;
}
.btn:hover{transform:translateY(-1px)}
.btn.ghost{
  background:transparent;
  border:1px solid var(--border);
  color:#ddd;
}

.file-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:8px 12px;
  border-radius:999px;
  margin:6px;
  font-size:13px;
  font-weight:600;
  box-shadow:0 4px 10px rgba(0,0,0,.25);
}

.tiles{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:14px;
}

.tile{
  padding:14px;
  border-radius:14px;
  cursor:pointer;
  border:1px solid var(--border);
  font-size:14px;
  background:rgba(255,255,255,.05);
  transition:.25s;
}
.tile:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 20px rgba(0,0,0,.35);
}
.tile.selected{
  outline:3px solid #fff;
  box-shadow:0 0 0 3px rgba(124,58,237,.7),
             0 0 30px rgba(124,58,237,.5);
}

input,select{
  padding:9px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0b1025;
  color:#fff;
  font-size:14px;
}

.mapping-row{
  display:flex;
  align-items:center;
  gap:10px;
}

.preview{
  max-height:460px;
  overflow:auto;
  border-radius:14px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
.tile-header{
  font-size:16px;
  font-weight:700;
  color:#ffffff;
  margin-bottom:4px;
}

.tile-file{
  font-size:12px;
  opacity:0.75;
  color:#e5e7eb;
}


th{
  position:sticky;
  top:0;
  background:linear-gradient(180deg,#111827,#020617);
  padding:12px;
  text-align:left;
}

td{
  padding:12px;
  vertical-align:top;
  word-break:break-word;
  line-height:1.45;
}

tr:nth-child(even){background:rgba(255,255,255,.03)}

.missing{
  background:linear-gradient(135deg,#7f1d1d,#3f0d0d);
  color:#fde68a;
}

.zeroVal{
  background:linear-gradient(135deg,#14532d,#052e16);
  color:#bbf7d0;
}

.search{margin-bottom:12px;width:100%}

@media(max-width:600px){
  body{padding:12px}
  h2{font-size:22px}
  .tiles{grid-template-columns:1fr}
}
</style>
</head>

<body>

<h2>üìä Excel Merger</h2>
<div class="small">‚úî Reference merge ‚úî Same header update ‚úî Professional view</div>

<div class="card">
  <button class="btn" onclick="fileInput.click()">üìÅ Add File</button>
  <input type="file" id="fileInput" hidden accept=".xlsx,.xls,.csv">
  <button class="btn" onclick="merge()">üîÄ Merge</button>
  <button class="btn ghost" onclick="resetAll()">üßπ Clear</button>
</div>

<div class="card">
  <h3>üìÇ Files</h3>
  <div id="fileList"></div>
</div>

<div class="card">
  <h3>üß© Select Headers</h3>
  <input class="search" placeholder="Search header" oninput="renderTiles(this.value)">
  <div id="tiles" class="tiles"></div>
</div>

<div class="card">
  <h3>üîó Rename Output Headers</h3>
  <div id="mapping"></div>
</div>

<div class="card" id="previewCard" style="display:none">
  <h3>üëÄ Preview</h3>
  <button class="btn" onclick="download()">‚¨á Download XLSX</button>
  <div class="preview" id="preview"></div>
</div>

<script>
const COLORS=["#22c55e","#38bdf8","#eab308","#f97316","#ec4899","#a78bfa"];
let files=[], selected=new Set(), headersMap={}, merged=[];
const norm=v=>(v??'').toString().trim();

fileInput.onchange=async()=>{
  const f=fileInput.files[0]; if(!f) return;
  const buf=await f.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  const sh=wb.Sheets[wb.SheetNames[0]];
  const data=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});

  files.push({
    id:crypto.randomUUID(),
    name:f.name,
    color:COLORS[files.length%COLORS.length],
    headers:data[0],
    rows:data.slice(1),
    refCol:0
  });

  renderFiles();
  buildHeaders();
};

function renderFiles(){
  fileList.innerHTML='';
  files.forEach(f=>{
    const d=document.createElement('div');
    d.className='file-chip';
    d.style.background=f.color;
    d.style.color='#000';
    d.textContent=f.name+' ';
    const s=document.createElement('select');
    f.headers.forEach((h,i)=>s.innerHTML+=`<option value="${i}">${h}</option>`);
    s.onchange=()=>f.refCol=+s.value;
    d.appendChild(s);
    fileList.appendChild(d);
  });
}

function buildHeaders(){
  headersMap={};
  files.forEach(f=>{
    f.headers.forEach((h,i)=>{
      headersMap[f.id+'::'+i]={file:f,header:h,col:i};
    });
  });
  renderTiles();
}

function renderTiles(q=''){
  tiles.innerHTML='';
  Object.entries(headersMap).forEach(([k,h])=>{
    if(q && !h.header.toLowerCase().includes(q.toLowerCase())) return;
    const t=document.createElement('div');
    t.className='tile'+(selected.has(k)?' selected':'');
    t.style.background=h.file.color+'55';
    t.style.borderColor=h.file.color;
   t.innerHTML = `
  <div class="tile-header">${h.header}</div>
  <div class="tile-file">${h.file.name}</div>
`;

    t.onclick=()=>{
      selected.has(k)?selected.delete(k):selected.add(k);
      renderTiles(q); renderMapping();
    };
    tiles.appendChild(t);
  });
}

function renderMapping(){
  mapping.innerHTML='';
  selected.forEach(k=>{
    const h=headersMap[k];
    const r=document.createElement('div');
    r.className='mapping-row';
    const i=document.createElement('input');
    i.value=h.out||h.header;
    i.oninput=()=>h.out=i.value;
    r.append('Output',i);
    mapping.appendChild(r);
  });
}

function merge(){
  merged=[];
  const refs=new Set();
  files.forEach(f=>f.rows.forEach(r=>{
    const ref=norm(r[f.refCol]);
    if(ref) refs.add(ref);
  }));

  refs.forEach(ref=>{
    const row={Reference:ref};
    selected.forEach(k=>{
      const h=headersMap[k];
      const header=norm(h.header);
      let val='';
      for(const f of files){
        const ci=f.headers.findIndex(x=>norm(x)===header);
        if(ci===-1) continue;
        const fr=f.rows.find(r=>norm(r[f.refCol])===ref);
        if(fr && fr[ci]!==''){val=fr[ci];break;}
      }
      row[h.out||h.header]=val;
    });
    merged.push(row);
  });
  showPreview();
}

function showPreview(){
  previewCard.style.display='block';
  const cols=Object.keys(merged[0]||{});
  let h='<table><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
  merged.forEach(r=>{
    h+='<tr>'+cols.map(c=>{
      let v=r[c],cls='';
      if(v==='') cls='missing';
      else if(v===0) cls='zeroVal';
      return `<td class="${cls}">${v}</td>`;
    }).join('')+'</tr>';
  });
  preview.innerHTML=h+'</table>';
}

function download(){
  const ws=XLSX.utils.json_to_sheet(merged);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Merged');
  XLSX.writeFile(wb,'merged.xlsx');
}

function resetAll(){
  files=[]; selected.clear(); headersMap={}; merged=[];
  fileList.innerHTML=''; tiles.innerHTML=''; mapping.innerHTML='';
  previewCard.style.display='none';
}
</script>

</body>
</html>
